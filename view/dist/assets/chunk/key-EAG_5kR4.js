import{m as l}from"./upload-Bns8lZv9.js";import{f as p}from"./ferdi-encryption-B9sfXnuY.js";const y="secure-db",r="keys",s="kek",c="ferdi-pv-iv",i="ferdi-pv-ciphertext";function u(){return new Promise((n,o)=>{const e=indexedDB.open(y,1);e.onupgradeneeded=()=>{const t=e.result;t.objectStoreNames.contains(r)||t.createObjectStore(r)},e.onerror=()=>o(e.error),e.onsuccess=()=>{const t=e.result;t.isClosed=!1,t.onversionchange=()=>{t.close(),t.isClosed=!0};const a=t.close.bind(t);t.close=()=>{t.isClosed=!0,a()},n(t)}})}async function d(n){const e=(await u()).transaction(r,"readwrite");return e.objectStore(r).put(n,s),new Promise(t=>e.oncomplete=t)}async function f(){const e=(await u()).transaction(r,"readonly").objectStore(r).get(s);return new Promise(t=>{e.onsuccess=()=>t(e.result||null),e.onerror=()=>t(null)})}async function b(){return crypto.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function m(n,o){const e=crypto.getRandomValues(new Uint8Array(12));return{ciphertext:new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM",iv:e},n,o)),iv:e}}async function w(n,o,e){return new Uint8Array(await crypto.subtle.decrypt({name:"AES-GCM",iv:e},n,o))}async function A(n){const o=await b();await d(o);const{ciphertext:e,iv:t}=await m(o,n);localStorage.setItem(i,btoa(String.fromCharCode(...e))),localStorage.setItem(c,btoa(String.fromCharCode(...t)))}async function K(){const n=await f();if(!n)throw new Error("KEK tidak ditemukan â€” berarti belum setup pertama.");const o=Uint8Array.from(atob(localStorage.getItem(i)||""),a=>a.charCodeAt(0)),e=Uint8Array.from(atob(localStorage.getItem(c)||""),a=>a.charCodeAt(0));return await w(n,o,e)}async function h(n=null){const o=l(n);return await fetch(o,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"}})}async function C(n=null){const o=await h(n);if(!o)throw new Error(`Cannot fetch public key ${n}`);const t=(await o.json()).key.public_key;return p(t)}async function S(){return await K()}export{S as a,h as f,C as g,A as s};
