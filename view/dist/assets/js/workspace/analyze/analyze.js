import{q as C,c as k,b as u,d as h,n as S,e as o,h as v,t as p,F as N,k as V,u as j,A as O,r as y,B as R,s as W,p as F,z as Z}from"../../../chunk/toDom-Dqu9wsvS.js";import{_ as D}from"../../../chunk/_plugin-vue_export-helper-DlAUqK2U.js";import{g as _,i as I,j as x}from"../../../chunk/ferdi-encryption-B9sfXnuY.js";const Y={key:0,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"mr-2 shrink-0 flex-shrink-0"},H={key:0,d:"M6 10l12 0",stroke:"currentColor"},L={key:1,xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"mr-2 shrink-0"},G={class:"truncate flex-1"},J={key:2,class:"text-xs text-gray-500 pl-2 whitespace-nowrap"},K={key:0,class:"ml-4 border-l-2 border-gray-100"},q=C({__name:"FolderTreeNode",props:{node:{},depth:{}},setup(s){const e=s,t=k(()=>e.depth??0),i=()=>{e.node.kind==="directory"&&(e.node.expanded=!e.node.expanded)},n=k(()=>t.value>0?`pl-${4+t.value*4}`:"");return(a,r)=>(h(),u("div",{class:S(["tree-node",n.value])},[o("div",{class:S(["flex items-center py-1 px-2 rounded hover:bg-gray-50 cursor-pointer",{"font-medium text-gray-800":s.node.kind==="directory","text-gray-600":s.node.kind==="file"}]),onClick:i},[s.node.kind==="directory"?(h(),u("svg",Y,[s.node.expanded?(h(),u("path",H)):v("",!0),r[0]||(r[0]=o("path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2Z"},null,-1))])):(h(),u("svg",L,[...r[1]||(r[1]=[o("path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"},null,-1),o("path",{d:"M14 2v4a2 2 0 0 0 2 2h4"},null,-1)])])),o("span",G,p(s.node.name),1),s.node.kind==="directory"?(h(),u("span",J," ("+p(s.node.children?.length||0)+") ",1)):v("",!0)],2),s.node.kind==="directory"&&s.node.expanded&&s.node.children?(h(),u("div",K,[(h(!0),u(N,null,V(s.node.children,l=>(h(),j(T,{key:l.id,node:l,depth:t.value+1},null,8,["node","depth"]))),128))])):v("",!0)],2))}}),T=D(q,[["__scopeId","data-v-fd711272"]]);function Q(s){return new Worker("/vendor/dochub/assets/js/worker/analyze.worker.js",{type:"module",name:s?.name})}function M(s){return s.kind==="file"?1:s.children?.length?s.children.reduce((e,t)=>e+M(t),0):0}async function U(s,e,t){for await(const i of s.values()){const n=`${e}/${i.name}`;await t(i,n)}}async function z(s,e){const t=[];return await U(s,e,async(i,n)=>{try{if(i.kind==="file"){const a=i;a.relativePath=n,t.push({id:crypto.randomUUID(),name:i.name,kind:"file",handler:a})}else if(i.kind==="directory"){const a=i;a.relativePath=n;let r=await z(i,n);t.push({id:crypto.randomUUID(),name:i.name,kind:"directory",handler:a,children:r,expanded:!1})}}catch(a){throw a.name==="NotFoundError"&&(console.warn(`[SKIP] Item tidak ditemukan: ${n}`,a),s.relativePath=n,t.push({id:crypto.randomUUID(),name:`${i.name} (hilang)`,kind:"file",handler:s})),a}}),t}function X(s,e){return new Promise(async(t,i)=>{let n;try{const a=new Q;a.postMessage({type:"makeFileNode",payload:{dirHandle:s,currentPath:e}}),a.onmessage=async r=>{const l=r.data.result;s.relativePath=s.name,n={id:"root",name:s.name,kind:"directory",handler:s,children:l,expanded:!0},t({worker:a,result:n})},a.onerror=r=>i(r)}catch{const r=await z(s,e),l={id:"root",name:s.name,kind:"directory",handler:s,children:r,expanded:!0};t({worker:null,result:l})}})}let ee=0;async function te(){return{userId:ee,userEmail:O()}}class se{partialVerifyThreshold=0;partialHashByte=0;fileSystem;file=null;hash=null;constructor(e){this.partialVerifyThreshold=2*1024*1024,this.partialHashByte=1*1024*1024,this.fileSystem=e}async getFile(){return this.file||await this.fileSystem.getFile(),this.file}async resolveHash(e){if(this.hash)return this.hash;if(this.file||(this.file=await this.fileSystem.getFile()),e){if(e=e.trim().toLowerCase(),!/^[a-f0-9]{64}$/.test(e))throw new Error("Invalid SHA-256 hash format");if(this.file.size<=this.partialVerifyThreshold){const t=await _(this.file);if(e!==t)throw new Error("Provided hash mismatch (full verify)")}else await this.verifyPartialHash(e);return e}return this.file.size<=this.partialVerifyThreshold?this.hash=await _(this.file):this.hash=await I(this.file,this.partialHashByte)}async verifyPartialHash(e){if(!/^ [a - f0 - 9]{ 64 } $ /.test(e))throw new Error("Invalid SHA-256 hash format");this.file||(this.file=await this.fileSystem.getFile());const t=await I(this.file,this.partialHashByte),i=e.substring(0,12),n=t.substring(0,12);if(i!==n)throw new Error("Partial hash verification failed")}}class ie{fileSystem;file=null;dhBlob=null;constructor(e){this.fileSystem=e}getBlob(){return this.dhBlob?this.dhBlob:this.dhBlob=new se(this.fileSystem)}async getPath(){return this.fileSystem.relativePath?this.fileSystem.relativePath:(this.dhBlob||this.getBlob(),(await this.dhBlob.getFile()).webkitRelativePath)}async getMtime(){return this.dhBlob||this.getBlob(),(await this.dhBlob.getFile()).lastModified/1e3}async getSize(){return this.dhBlob||this.getBlob(),(await this.dhBlob.getFile()).size}async toObject(){this.dhBlob||this.getBlob();const e=await this.dhBlob.resolveHash(),t=await this.dhBlob.getFile();return{relative_path:await this.getPath(),sha256:e,size_bytes:t.size,file_modified_at:await this.getMtime()}}toJson(){return JSON.stringify(this.toObject())}}var w=(s=>(s.CMS="cms",s.API="api",s.UPLOAD="upload",s.CI="ci",s.BACKUP="backup",s.MIGRATION="migration",s))(w||{});(s=>{function e(){return Object.values(s)}s.values=e;function t(i){return e().includes(i)}s.isValid=t})(w||(w={}));const B=/^[a-z0-9-]+$/,P=/^(prod|staging|dev|test)$/,E=/^v?\d+(\.\d+)*[a-z0-9-]*$/i;class ae{static makeSource(e,t,i,n){if(!w.isValid(e))throw new Error(`Invalid type '${e}'. Must be one of: ${w.values().join(", ")}`);if(!B.test(t))throw new Error(`Invalid identifier '${t}'. Must be lowercase alphanumeric with hyphens (e.g., 'client-a').`);if(i!=null&&!P.test(i))throw new Error(`Invalid environment '${i}'. Must be 'prod', 'staging', 'dev', or 'test'.`);if(n!=null&&!E.test(n))throw new Error(`Invalid version '${n}'. Must be like 'v1', '2.1.0', 'rc-1'.`);const a=[t];return i&&a.push(i),n&&a.push(n),`${e}:${a.join("-")}`}static parseSource(e){if(!/^[a-z]+:[a-z0-9-]+(?:-[a-z0-9-]+)*$/.test(e))throw new Error("Invalid source format. Expected 'type:identifier[-env][-ver]' (e.g., 'cms:client-a-prod-v1').");const[t,i]=e.split(":",2);if(i===void 0)throw new Error("Source must contain exactly one ':'");const n=t,a=i.split("-");if(a.length===0)throw new Error("Identifier cannot be empty");let r=a[0],l=null,f=null;const d=a.slice(1);if(d.length>0){const g=d[d.length-1];E.test(g)&&(f=g,d.pop())}if(d.length>0){const g=d[d.length-1];P.test(g)&&(l=g,d.pop())}if(d.length>0&&(r+="-"+d.join("-")),!w.isValid(n))throw new Error(`Invalid type in parsed source: '${n}'`);if(!B.test(r))throw new Error(`Invalid identifier in parsed source: '${r}'`);return{type:n,identifier:r,environment:l,version:f}}static isValid(e){try{return this.parseSource(e),!0}catch{return!1}}static getEnvironment(e){return this.parseSource(e).environment}static getVersion(e){return this.parseSource(e).version}}class ne{static method="ISO 8601";static isoFormat="YYYY-MM-DDTHH:mm:ss.SSSZ";static isoPattern=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/;static makeVersion(){const e=new Date,t=e.getUTCFullYear(),i=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0"),a=String(e.getUTCHours()).padStart(2,"0"),r=String(e.getUTCMinutes()).padStart(2,"0"),l=String(e.getUTCSeconds()).padStart(2,"0"),f=String(e.getUTCMilliseconds()).padStart(3,"0");return`${t}-${i}-${n}T${a}:${r}:${l}.${f}Z`}static isValid(e,t="ISO 8601"){return t!=="ISO 8601"?!1:this.isIsoFormat(e)}static timestampToIso9601(e){let t;if(e==null)t=new Date;else if(e instanceof Date)t=e;else if(typeof e=="number")t=new Date(e*(e>1e10?1:1e3));else if(t=new Date(e),isNaN(t.getTime()))throw new Error(`Invalid timestamp input: '${e}'`);return this.formatIso(t)}static isIsoFormat(e){if(!this.isoPattern.test(e))return!1;const t=e.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})\.(\d{3})Z/);if(!t)return!1;const[,i,n,a,r,l,f,d]=t.map(Number);if(n<1||n>12||a<1||a>31||r<0||r>23||l<0||l>59||f<0||f>59||d<0||d>999)return!1;const g=new Date(Date.UTC(i,n-1,a,r,l,f,d));return this.formatIso(g)===e}static formatIso(e){const t=e.getUTCFullYear(),i=String(e.getUTCMonth()+1).padStart(2,"0"),n=String(e.getUTCDate()).padStart(2,"0"),a=String(e.getUTCHours()).padStart(2,"0"),r=String(e.getUTCMinutes()).padStart(2,"0"),l=String(e.getUTCSeconds()).padStart(2,"0"),f=String(e.getUTCMilliseconds()).padStart(3,"0");return`${t}-${i}-${n}T${a}:${r}:${l}.${f}Z`}}class re{source;version;totalFiles=0;totalSizeBytes=0;files=new Set;histories=[];constructor(e,t){this.source=e,this.version=t}async setFiles(e){const{files:t}=await this.ifDir(e);this.files=t}async getFiles(e=null){return this.files.size<1&&e&&this.setFiles(e),this.files}async getHistories(){return{}}hash(e){return Array.isArray(e)?x(JSON.stringify(e)):x(e)}async ifDir(e,t=new Set){return await U(e,e.name,async(i,n)=>{if(i.kind==="file")t.add(new ie(i));else if(i.kind==="directory"){const a=await this.ifDir(i,t);t=new Set([...t,...a.files])}}),{files:t}}async toObject(e){this.files.size<1&&await this.setFiles(e);const t=[];for(const i of this.files)t.push(await i.toObject());return{source:this.source,version:this.version,total_files:this.totalFiles,total_size_bytes:this.totalSizeBytes,hash_tree_sha256:this.hash(t),files:t,histories:await this.getHistories()}}}class oe{dhWorkspaceParam;manifest=null;constructor(e){this.dhWorkspaceParam=e}async setManifest(){const{userEmail:e}=await te(),t=x(e),i=ae.makeSource(w.UPLOAD,t.toString()),n=ne.makeVersion(),a=new re(i,n);this.manifest=await a.toObject(this.dhWorkspaceParam)}async getManifest(){return this.manifest||await this.setManifest(),this.manifest}}const le={class:"upload-manager max-w-4xl mx-auto"},de={class:"env-badge env-development mt-4"},ce={key:0},he={class:"info text-lg font-medium text-gray-700"},ue={key:0,class:"hint mt-2"},fe={key:1,class:"hint mt-2"},me=["disabled"],ge={key:1,class:"result failed mt-6"},pe={class:"result-content"},ve={key:2,class:"mt-8"},we={class:"flex justify-between items-center mb-3"},ye={class:"bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"},be={class:"mt-4 text-sm text-gray-500"},ke={class:"font-mono"},Se={class:"mt-4 text-sm text-gray-500"},xe=["disabled"],$e=C({__name:"FolderAnalyzer",setup(s){const e=y(!1),t=y(null),i=y(null),n=y(""),a=y(!1),r=y(null);async function l(){e.value=!0,i.value=null,t.value=null;try{r.value=await window.showDirectoryPicker(),n.value=r.value.name;const{worker:m,result:c}=await X(r.value,r.value.name);r.value.relativePath=r.value.name,t.value=c,m&&m.terminate(),a.value=!0}catch(m){m.name==="AbortError"?i.value="Pengguna membatalkan pemilihan folder.":(console.error("‚ùå Error:",m),i.value=`Gagal: ${m.message}`)}finally{e.value=!1}}const f=()=>{if(!t.value)return;const m=(b,$)=>{b.kind==="directory"&&(b.expanded=$,b.children?.forEach(A=>m(A,$)))},c=!t.value.expanded;m(t.value,c),t.value.expanded=c},d=k(()=>t.value?M(t.value):0);async function g(){if(r.value){const c=await new oe(r.value).getManifest();console.log(top.manifest=c)}}return(m,c)=>(h(),u("div",le,[o("div",de,[o("span",null,"üìÅ Folder: "+p(n.value||"Belum dipilih"),1),t.value?(h(),u("span",ce,"üìÅ "+p(d.value)+" items",1)):v("",!0)]),a.value?v("",!0):(h(),u("div",{key:0,class:S(["upload-zone flex flex-col items-center justify-center py-12",{"cursor-not-allowed opacity-75":e.value}])},[o("p",he,p(e.value?"Sedang memindai...":"Klik tombol di bawah untuk memilih folder"),1),e.value?v("",!0):(h(),u("p",ue," Hanya didukung di Chrome/Edge (File System Access API) ")),e.value?v("",!0):(h(),u("p",fe," Does not support symbolic link ")),o("button",{onClick:l,disabled:e.value,class:"mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition flex items-center gap-2 disabled:opacity-50"}," Pilih & Analisis Folder ",8,me)],2)),i.value?(h(),u("div",ge,[c[1]||(c[1]=R('<div class="result-icon" data-v-ab60856b><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" data-v-ab60856b><circle cx="12" cy="12" r="10" data-v-ab60856b></circle><line x1="12" y1="8" x2="12" y2="12" data-v-ab60856b></line><line x1="12" y1="16" x2="12.01" y2="16" data-v-ab60856b></line></svg></div>',1)),o("div",pe,[c[0]||(c[0]=o("h3",{class:"font-bold"},"Gagal Memindai Folder",-1)),o("p",null,p(i.value),1)])])):v("",!0),t.value&&!e.value?(h(),u("div",ve,[o("div",we,[c[2]||(c[2]=o("h2",{class:"text-xl font-bold text-gray-800"},"Struktur Folder",-1)),o("button",{onClick:f,class:"text-sm text-blue-600 hover:text-blue-800"},p(t.value.expanded?"Tutup Semua":"Buka Semua"),1)]),o("div",ye,[W(T,{node:t.value},null,8,["node"])]),o("div",be,[o("p",null,[c[3]||(c[3]=F(" üìÅ Root: ",-1)),o("code",null,p(t.value.name),1)]),o("p",null,[c[4]||(c[4]=F(" üìù Total item: ",-1)),o("span",ke,p(d.value),1)])]),o("div",Se,[o("button",{onClick:g,disabled:e.value,class:"mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition flex items-center gap-2 disabled:opacity-50"}," Create Manifest ",8,xe)])])):v("",!0)]))}}),Fe=D($e,[["__scopeId","data-v-ab60856b"]]);Z(Fe).mount("#analyze-app");
